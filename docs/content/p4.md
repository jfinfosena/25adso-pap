# Clase 4: Rutas y ParÃ¡metros en FastAPI

### ğŸ¯ **Objetivo de la clase**
Aprender a definir rutas en FastAPI, manejar diferentes mÃ©todos HTTP y extraer datos de:
- ParÃ¡metros de ruta
- ParÃ¡metros de consulta

Se enfatizarÃ¡ el uso del tipado de Python para obtener validaciÃ³n automÃ¡tica y documentaciÃ³n en Swagger.

---

## ğŸ§© **1. DefiniciÃ³n de Rutas**

En FastAPI, las rutas (o endpoints) se definen usando decoradores como `@app.get`, `@app.post`, etc., asociados a funciones.

```python
from fastapi import FastAPI

app = FastAPI()

@app.get("/")
def home():
    return {"mensaje": "Â¡Bienvenido a la API!"}
```

> âœ… FastAPI usa el **mÃ©todo HTTP** y la **ruta** para enrutar las solicitudes.

---

## ğŸ”— **2. ParÃ¡metros de Ruta (Path Parameters)**

Son valores que forman parte de la URL y se usan para identificar recursos especÃ­ficos.

### Ejemplo: Obtener un usuario por ID

```python
@app.get("/usuarios/{user_id}")
def obtener_usuario(user_id: int):
    return {"user_id": user_id, "nombre": f"Usuario {user_id}"}
```

- `{user_id}` es un **parÃ¡metro de ruta**.
- `user_id: int` indica que espera un nÃºmero entero â†’ FastAPI valida y convierte automÃ¡ticamente.

### âœ… Ventajas:
- ValidaciÃ³n automÃ¡tica: si se pasa `"abc"`, FastAPI responde con error 422.
- DocumentaciÃ³n automÃ¡tica en `/docs`.

---

## ğŸ” **3. ParÃ¡metros de Consulta (Query Parameters)**

Son parÃ¡metros opcionales que vienen despuÃ©s del `?` en la URL.

```python
@app.get("/productos/")
def listar_productos(categoria: str = None, en_stock: bool = False, limite: int = 10):
    resultados = {
        "categoria": categoria,
        "en_stock": en_stock,
        "limite": limite,
        "productos": [
            {"id": 1, "nombre": "Laptop", "categoria": "tecnologÃ­a", "stock": True},
            {"id": 2, "nombre": "Teclado", "categoria": "tecnologÃ­a", "stock": True}
        ]
    }
    return resultados
```

- URL de ejemplo:  
  `http://localhost:8000/productos/?categoria=tecnologÃ­a&en_stock=true&limite=5`

> âš ï¸ Los parÃ¡metros de consulta son **opcionales** si tienen valor por defecto.

---

## ğŸ“¡ **4. MÃ©todos HTTP Soportados**

FastAPI soporta todos los mÃ©todos comunes:

| MÃ©todo | Uso comÃºn |
|--------|----------|
| `GET`  | Leer datos |
| `POST` | Crear datos |
| `PUT`  | Actualizar datos (completos) |
| `PATCH`| Actualizar datos (parciales) |
| `DELETE`| Eliminar datos |

---

## ğŸš€ Tutorial Completo: API FastAPI + Postman con JSON y Query Parameters

---

### ğŸ§° 1. Requisitos previos

AsegÃºrate de tener instalado:

```bash
pip install fastapi uvicorn
```

> FastAPI incluye `pydantic`, asÃ­ que no necesitas instalarlo por separado.

---

### ğŸ’» 2. CÃ³digo FastAPI actualizado (con JSON y Query Parameters)

Guarda este cÃ³digo en un archivo llamado `main.py`:

```python
from fastapi import FastAPI, Query
from pydantic import BaseModel
from typing import Optional

app = FastAPI()

# Modelo base para items
class Item(BaseModel):
    nombre: str
    precio: float

# Modelo para actualizaciÃ³n parcial
class ItemParcial(BaseModel):
    nombre: Optional[str] = None
    precio: Optional[float] = None

# Base de datos simulada
items = [
    {"id": 1, "nombre": "Manzana", "precio": 1.2},
    {"id": 2, "nombre": "Banana", "precio": 0.8},
    {"id": 3, "nombre": "Naranja", "precio": 1.5}
]

# ğŸ”¹ GET: Listar todos los items + filtro por nombre (query parameter)
@app.get("/items/")
def obtener_items(nombre: str = Query(None, description="Filtrar por nombre")):
    resultado = items
    if nombre:
        resultado = [item for item in items if nombre.lower() in item["nombre"].lower()]
    return {"items": resultado}

# ğŸ”¹ GET: Obtener un item por ID
@app.get("/items/{item_id}")
def obtener_item(item_id: int):
    for item in items:
        if item["id"] == item_id:
            return item
    return {"error": "Item no encontrado"}

# ğŸ”· POST: Crear un nuevo item (JSON)
@app.post("/items/")
def crear_item(item: Item):
    nuevo_id = max([i["id"] for i in items]) + 1
    nuevo_item = {"id": nuevo_id, "nombre": item.nombre, "precio": item.precio}
    items.append(nuevo_item)
    return {"mensaje": "Item creado", "item": nuevo_item}

# ğŸ”¶ PUT: Actualizar un item completo (JSON)
@app.put("/items/{item_id}")
def actualizar_item(item_id: int, item: Item):
    for i in items:
        if i["id"] == item_id:
            i["nombre"] = item.nombre
            i["precio"] = item.precio
            return {"mensaje": "Item actualizado", "item": i}
    return {"error": "Item no encontrado"}

# ğŸŸ¡ PATCH: Actualizar parcialmente un item (JSON)
@app.patch("/items/{item_id}")
def actualizar_parcial(item_id: int, item: ItemParcial):
    for i in items:
        if i["id"] == item_id:
            if item.nombre is not None:
                i["nombre"] = item.nombre
            if item.precio is not None:
                i["precio"] = item.precio
            return {"mensaje": "Item actualizado parcialmente", "item": i}
    return {"error": "Item no encontrado"}

# ğŸ”» DELETE: Eliminar un item
@app.delete("/items/{item_id}")
def eliminar_item(item_id: int):
    for item in items:
        if item["id"] == item_id:
            items.remove(item)
            return {"mensaje": "Item eliminado"}
    return {"error": "Item no encontrado"}
```

---

### â–¶ï¸ 3. Iniciar el servidor

Desde la terminal:

```bash
uvicorn main:app --reload
```

Tu API estarÃ¡ disponible en:
- `http://127.0.0.1:8000`
- DocumentaciÃ³n interactiva: `http://127.0.0.1:8000/docs`

---

### ğŸ§ª 4. Pruebas en Postman (con JSON)

Abre **Postman** y sigue estos pasos.

---

#### ğŸ”¹ 1. GET: Listar todos los items

- **MÃ©todo:** `GET`
- **URL:** `http://127.0.0.1:8000/items/`
- **Body:** No necesario
- **Respuesta:**
```json
{
  "items": [
    {"id": 1, "nombre": "Manzana", "precio": 1.2},
    {"id": 2, "nombre": "Banana", "precio": 0.8},
    {"id": 3, "nombre": "Naranja", "precio": 1.5}
  ]
}
```

---

#### ğŸ” 2. GET con Query Parameter: Filtrar por nombre

- **URL:** `http://127.0.0.1:8000/items/?nombre=ana`
- Esto filtra los items cuyo nombre contenga "ana" (ej. "Banana")

âœ… Respuesta:
```json
{
  "items": [
    {"id": 2, "nombre": "Banana", "precio": 0.8}
  ]
}
```

> Puedes probar con `?nombre=na`, `?nombre=zana`, etc.

---

#### ğŸ”¹ 3. GET por ID: `/items/1`

- **MÃ©todo:** `GET`
- **URL:** `http://127.0.0.1:8000/items/1`
- Respuesta:
```json
{"id": 1, "nombre": "Manzana", "precio": 1.2}
```

---

#### ğŸ”· 4. POST: Crear item (JSON)

- **MÃ©todo:** `POST`
- **URL:** `http://127.0.0.1:8000/items/`
- **Body â†’ raw â†’ JSON:**
```json
{
  "nombre": "Papaya",
  "precio": 2.5
}
```
- **Headers (opcional pero recomendado):**
  - `Content-Type: application/json`

âœ… Respuesta:
```json
{
  "mensaje": "Item creado",
  "item": {
    "id": 4,
    "nombre": "Papaya",
    "precio": 2.5
  }
}
```

---

#### ğŸ”¶ 5. PUT: Actualizar completo

- **MÃ©todo:** `PUT`
- **URL:** `http://127.0.0.1:8000/items/4`
- **Body (JSON):**
```json
{
  "nombre": "Mango",
  "precio": 3.0
}
```
âœ… Respuesta:
```json
{
  "mensaje": "Item actualizado",
  "item": {
    "id": 4,
    "nombre": "Mango",
    "precio": 3.0
  }
}
```

---

#### ğŸŸ¡ 6. PATCH: Actualizar parcialmente

- **MÃ©todo:** `PATCH`
- **URL:** `http://127.0.0.1:8000/items/4`
- **Body (solo precio):**
```json
{
  "precio": 2.8
}
```
âœ… Respuesta:
```json
{
  "mensaje": "Item actualizado parcialmente",
  "item": {
    "id": 4,
    "nombre": "Mango",
    "precio": 2.8
  }
}
```

---

#### ğŸ”» 7. DELETE: Eliminar item

- **MÃ©todo:** `DELETE`
- **URL:** `http://127.0.0.1:8000/items/4`
- Respuesta:
```json
{"mensaje": "Item eliminado"}
```

---

### ğŸ” Â¿QuÃ© son los Query Parameters?

Son parÃ¡metros que se agregan **despuÃ©s del `?` en la URL** y permiten filtrar, paginar o personalizar la respuesta.

En este ejemplo:
```python
def obtener_items(nombre: str = Query(None, description="Filtrar por nombre"))
```

- `nombre` es un **query parameter opcional**
- Si se envÃ­a, filtra los items por nombre
- Ejemplo: `/items/?nombre=ana`

Puedes usar varios:
```
/items/?nombre=na&otro_param=valor
```

---

### âœ… Ventajas de este enfoque

| CaracterÃ­stica           | Beneficio |
|--------------------------|---------|
| JSON en el body          | EstÃ¡ndar moderno, fÃ¡cil de usar con frontend |
| Pydantic + BaseModel     | ValidaciÃ³n automÃ¡tica de datos |
| Query Parameters         | Filtros flexibles sin cambiar la ruta |
| DocumentaciÃ³n automÃ¡tica | Swagger UI en `/docs` |

---

Perfecto. A continuaciÃ³n, te presento la **versiÃ³n final y completa de la actividad prÃ¡ctica**, ahora con **indicaciones detalladas para estudiantes**, enfocada en **resoluciÃ³n autÃ³noma** (sin dar la soluciÃ³n), e incluyendo:

- Crear un fork de un repositorio
- Trabajar con entorno virtual
- Instalar dependencias
- Editar archivo `info.json`
- Desarrollar la API segÃºn los requisitos

---

## ğŸ¾ Actividad PrÃ¡ctica: GestiÃ³n de Productos en una Tienda de Mascotas

> **Nivel:** Intermedio  
> **DuraciÃ³n estimada:** 1.5 â€“ 2 horas  
> **Objetivo:** Aplicar conocimientos de FastAPI, CRUD, JSON y parÃ¡metros de consulta en un proyecto realista, usando buenas prÃ¡cticas de desarrollo.

---

### ğŸ“¥ 1. PreparaciÃ³n del entorno de trabajo

#### ğŸ”— Paso 1: Haz un **fork** de un repositorio base

1. Ve al repositorio base proporcionado por tu instructor (ejemplo simulado):
   ```
   https://github.com/jfinfosena/act_pap_s3.git
   ```

2. Haz clic en el botÃ³n **"Fork"** en la esquina superior derecha.

3. Elige tu cuenta de GitHub como destino.

4. Una vez creado, tendrÃ¡s un repositorio en tu cuenta:
   ```
   https://github.com/tu-usuario/act_pap_s3.git
   ```

> âœ… Esto te permite trabajar sobre tu copia sin afectar el original.

---

#### ğŸ“¦ Paso 2: Clona tu repositorio (el fork)

En tu mÃ¡quina, abre una terminal y ejecuta:

```bash
git clone https://github.com/tu-usuario/act_pap_s3.git
cd act_pap_s3
```

> âš ï¸ Reemplaza `tu-usuario` con tu nombre de usuario de GitHub.

---

#### ğŸ Paso 3: Crea un entorno virtual

Es importante aislar las dependencias del proyecto.

```bash
# Crear entorno virtual
python -m venv .venv

# Activar entorno (Linux/Mac)
source .venv/bin/activate

# Activar entorno (Windows)
venv\Scripts\activate
```

> VerÃ¡s `(.venv)` al inicio de tu terminal. Â¡EstÃ¡s listo!

---

#### ğŸ”§ Paso 4: Instala las dependencias

El proyecto ya incluye un archivo `requirements.txt` con las dependencias necesarias.

```bash
pip install -r requirements.txt
```

> Esto instalarÃ¡ `fastapi` y `uvicorn` automÃ¡ticamente.

---

#### ğŸ“„ Paso 5: Diligencia el archivo `info.json`

En la raÃ­z del repositorio, encontrarÃ¡s un archivo llamado:

```json
info.json
```

Ãbrelo y **completa los campos** con tu informaciÃ³n:

```json
{
    "identificacion": "",
    "nombres": "",
    "apellidos": "",
    "grupo": "pap"
}
```

> âœ… Este archivo serÃ¡ parte de tu entrega y ayudarÃ¡ a identificar tu trabajo.

---

### ğŸ› ï¸ 2. Desarrollo de la API

Ahora sÃ­, es momento de programar.

#### ğŸ“ Estructura del proyecto

Tu repositorio debe tener estos archivos:

```
tienda-mascotas-base/
â”‚
â”œâ”€â”€ main.py          â† AquÃ­ desarrollarÃ¡s la API
â”œâ”€â”€ info.json        â† Ya lo completaste
â”œâ”€â”€ requirements.txt â† Con fastapi y uvicorn
â””â”€â”€ README.md        â† Instrucciones generales
```

---

#### ğŸ¯ Requisitos tÃ©cnicos

Crea una API FastAPI que gestione productos de una tienda de mascotas. Debes implementar:

##### âœ… Modelo `Producto`
Define un modelo Pydantic con:
- `nombre: str`
- `precio: float`
- `categoria: str` (ej: "alimento", "juguetes", "accesorios")
- `stock: int`

##### âœ… Modelo `ProductoParcial` (para PATCH)
Todos los campos deben ser opcionales (`Optional`).

##### âœ… Base de datos simulada
Declara una lista `productos = [...]` con al menos 3 productos iniciales.

##### âœ… Endpoints

| MÃ©todo | Ruta | DescripciÃ³n |
|--------|------|-------------|
| `GET` | `/productos/` | Listar todos los productos |
| `GET` | `/productos/{producto_id}` | Obtener producto por ID |
| `GET` | `/productos/?categoria=...` | Filtrar por categorÃ­a (query param) |
| `GET` | `/productos/?nombre=...` | Filtrar por nombre (bÃºsqueda parcial, insensitive) |
| `POST` | `/productos/` | Crear nuevo producto (recibe JSON) |
| `PUT` | `/productos/{producto_id}` | Actualizar todos los campos del producto |
| `PATCH` | `/productos/{producto_id}` | Actualizar solo algunos campos (ej: solo el stock) |
| `DELETE` | `/productos/{producto_id}` | Eliminar un producto |

---

#### ğŸ’¡ Pistas para ayudarte (sin dar la soluciÃ³n)

- Usa `Query(None)` para hacer los parÃ¡metros de consulta opcionales.
- Para bÃºsquedas parciales, usa `if query in item["nombre"].lower()`.
- Recuerda que `PUT` reemplaza todo; `PATCH` solo actualiza lo enviado.
- Usa `pydantic.BaseModel` para validar el cuerpo de las solicitudes.
- Ejecuta el servidor con:  
  ```bash
  uvicorn main:app --reload
  ```
- Prueba todo en **Postman** o en `http://127.0.0.1:8000/docs`

---

### ğŸ§ª 3. Pruebas recomendadas

Antes de entregar, verifica que:

- Todos los endpoints funcionen correctamente.
- Los filtros por `nombre` y `categoria` devuelvan los resultados esperados.
- Puedas crear, modificar y eliminar productos.
- Los mensajes de error (`"Producto no encontrado"`) se muestren cuando corresponde.

---

### ğŸ“¤ 4. Entrega

Cuando termines:

1. AsegÃºrate de que todo estÃ© guardado.
2. Haz commit y push a tu repositorio:

```bash
git add .
git commit -m "feat: completa API de productos para tienda de mascotas"
git push origin main
```

3. Entrega el **enlace a tu repositorio fork** en el sistema de tareas (Moodle, Classroom, etc.).

---



