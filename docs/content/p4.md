# Clase 4: Rutas y Par√°metros en FastAPI

### üéØ **Objetivo de la clase**
Aprender a definir rutas en FastAPI, manejar diferentes m√©todos HTTP y extraer datos de:
- Par√°metros de ruta
- Par√°metros de consulta

Se enfatizar√° el uso del tipado de Python para obtener validaci√≥n autom√°tica y documentaci√≥n en Swagger.

---

## üß© **1. Definici√≥n de Rutas**

En FastAPI, las rutas (o endpoints) se definen usando decoradores como `@app.get`, `@app.post`, etc., asociados a funciones.

```python
from fastapi import FastAPI

app = FastAPI()

@app.get("/")
def home():
    return {"mensaje": "¬°Bienvenido a la API!"}
```

> ‚úÖ FastAPI usa el **m√©todo HTTP** y la **ruta** para enrutar las solicitudes.

---

## üîó **2. Par√°metros de Ruta (Path Parameters)**

Son valores que forman parte de la URL y se usan para identificar recursos espec√≠ficos.

### Ejemplo: Obtener un usuario por ID

```python
@app.get("/usuarios/{user_id}")
def obtener_usuario(user_id: int):
    return {"user_id": user_id, "nombre": f"Usuario {user_id}"}
```

- `{user_id}` es un **par√°metro de ruta**.
- `user_id: int` indica que espera un n√∫mero entero ‚Üí FastAPI valida y convierte autom√°ticamente.

### ‚úÖ Ventajas:
- Validaci√≥n autom√°tica: si se pasa `"abc"`, FastAPI responde con error 422.
- Documentaci√≥n autom√°tica en `/docs`.

---

## üîç **3. Par√°metros de Consulta (Query Parameters)**

Son par√°metros opcionales que vienen despu√©s del `?` en la URL.

```python
@app.get("/productos/")
def listar_productos(categoria: str = None, en_stock: bool = False, limite: int = 10):
    resultados = {
        "categoria": categoria,
        "en_stock": en_stock,
        "limite": limite,
        "productos": [
            {"id": 1, "nombre": "Laptop", "categoria": "tecnolog√≠a", "stock": True},
            {"id": 2, "nombre": "Teclado", "categoria": "tecnolog√≠a", "stock": True}
        ]
    }
    return resultados
```

- URL de ejemplo:  
  `http://localhost:8000/productos/?categoria=tecnolog√≠a&en_stock=true&limite=5`

> ‚ö†Ô∏è Los par√°metros de consulta son **opcionales** si tienen valor por defecto.

---

## üì° **4. M√©todos HTTP Soportados**

FastAPI soporta todos los m√©todos comunes:

| M√©todo | Uso com√∫n |
|--------|----------|
| `GET`  | Leer datos |
| `POST` | Crear datos |
| `PUT`  | Actualizar datos (completos) |
| `PATCH`| Actualizar datos (parciales) |
| `DELETE`| Eliminar datos |

---

## üöÄ Tutorial Completo: API FastAPI + Postman con JSON y Query Parameters

---

### üß∞ 1. Requisitos previos

Aseg√∫rate de tener instalado:

```bash
pip install fastapi uvicorn
```

> FastAPI incluye `pydantic`, as√≠ que no necesitas instalarlo por separado.

---

### üíª 2. C√≥digo FastAPI actualizado (con JSON y Query Parameters)

Guarda este c√≥digo en un archivo llamado `main.py`:

```python
from fastapi import FastAPI, Query
from pydantic import BaseModel
from typing import Optional

app = FastAPI()

# Modelo base para items
class Item(BaseModel):
    nombre: str
    precio: float

# Modelo para actualizaci√≥n parcial
class ItemParcial(BaseModel):
    nombre: Optional[str] = None
    precio: Optional[float] = None

# Base de datos simulada
items = [
    {"id": 1, "nombre": "Manzana", "precio": 1.2},
    {"id": 2, "nombre": "Banana", "precio": 0.8},
    {"id": 3, "nombre": "Naranja", "precio": 1.5}
]

# üîπ GET: Listar todos los items + filtro por nombre (query parameter)
@app.get("/items/")
def obtener_items(nombre: str = Query(None, description="Filtrar por nombre")):
    resultado = items
    if nombre:
        resultado = [item for item in items if nombre.lower() in item["nombre"].lower()]
    return {"items": resultado}

# üîπ GET: Obtener un item por ID
@app.get("/items/{item_id}")
def obtener_item(item_id: int):
    for item in items:
        if item["id"] == item_id:
            return item
    return {"error": "Item no encontrado"}

# üî∑ POST: Crear un nuevo item (JSON)
@app.post("/items/")
def crear_item(item: Item):
    nuevo_id = max([i["id"] for i in items]) + 1
    nuevo_item = {"id": nuevo_id, "nombre": item.nombre, "precio": item.precio}
    items.append(nuevo_item)
    return {"mensaje": "Item creado", "item": nuevo_item}

# üî∂ PUT: Actualizar un item completo (JSON)
@app.put("/items/{item_id}")
def actualizar_item(item_id: int, item: Item):
    for i in items:
        if i["id"] == item_id:
            i["nombre"] = item.nombre
            i["precio"] = item.precio
            return {"mensaje": "Item actualizado", "item": i}
    return {"error": "Item no encontrado"}

# üü° PATCH: Actualizar parcialmente un item (JSON)
@app.patch("/items/{item_id}")
def actualizar_parcial(item_id: int, item: ItemParcial):
    for i in items:
        if i["id"] == item_id:
            if item.nombre is not None:
                i["nombre"] = item.nombre
            if item.precio is not None:
                i["precio"] = item.precio
            return {"mensaje": "Item actualizado parcialmente", "item": i}
    return {"error": "Item no encontrado"}

# üîª DELETE: Eliminar un item
@app.delete("/items/{item_id}")
def eliminar_item(item_id: int):
    for item in items:
        if item["id"] == item_id:
            items.remove(item)
            return {"mensaje": "Item eliminado"}
    return {"error": "Item no encontrado"}
```

---

### ‚ñ∂Ô∏è 3. Iniciar el servidor

Desde la terminal:

```bash
uvicorn main:app --reload
```

Tu API estar√° disponible en:
- `http://127.0.0.1:8000`
- Documentaci√≥n interactiva: `http://127.0.0.1:8000/docs`

---

### üß™ 4. Pruebas en Postman (con JSON)

Abre **Postman** y sigue estos pasos.

---

#### üîπ 1. GET: Listar todos los items

- **M√©todo:** `GET`
- **URL:** `http://127.0.0.1:8000/items/`
- **Body:** No necesario
- **Respuesta:**
```json
{
  "items": [
    {"id": 1, "nombre": "Manzana", "precio": 1.2},
    {"id": 2, "nombre": "Banana", "precio": 0.8},
    {"id": 3, "nombre": "Naranja", "precio": 1.5}
  ]
}
```

---

#### üîé 2. GET con Query Parameter: Filtrar por nombre

- **URL:** `http://127.0.0.1:8000/items/?nombre=ana`
- Esto filtra los items cuyo nombre contenga "ana" (ej. "Banana")

‚úÖ Respuesta:
```json
{
  "items": [
    {"id": 2, "nombre": "Banana", "precio": 0.8}
  ]
}
```

> Puedes probar con `?nombre=na`, `?nombre=zana`, etc.

---

#### üîπ 3. GET por ID: `/items/1`

- **M√©todo:** `GET`
- **URL:** `http://127.0.0.1:8000/items/1`
- Respuesta:
```json
{"id": 1, "nombre": "Manzana", "precio": 1.2}
```

---

#### üî∑ 4. POST: Crear item (JSON)

- **M√©todo:** `POST`
- **URL:** `http://127.0.0.1:8000/items/`
- **Body ‚Üí raw ‚Üí JSON:**
```json
{
  "nombre": "Papaya",
  "precio": 2.5
}
```
- **Headers (opcional pero recomendado):**
  - `Content-Type: application/json`

‚úÖ Respuesta:
```json
{
  "mensaje": "Item creado",
  "item": {
    "id": 4,
    "nombre": "Papaya",
    "precio": 2.5
  }
}
```

---

#### üî∂ 5. PUT: Actualizar completo

- **M√©todo:** `PUT`
- **URL:** `http://127.0.0.1:8000/items/4`
- **Body (JSON):**
```json
{
  "nombre": "Mango",
  "precio": 3.0
}
```
‚úÖ Respuesta:
```json
{
  "mensaje": "Item actualizado",
  "item": {
    "id": 4,
    "nombre": "Mango",
    "precio": 3.0
  }
}
```

---

#### üü° 6. PATCH: Actualizar parcialmente

- **M√©todo:** `PATCH`
- **URL:** `http://127.0.0.1:8000/items/4`
- **Body (solo precio):**
```json
{
  "precio": 2.8
}
```
‚úÖ Respuesta:
```json
{
  "mensaje": "Item actualizado parcialmente",
  "item": {
    "id": 4,
    "nombre": "Mango",
    "precio": 2.8
  }
}
```

---

#### üîª 7. DELETE: Eliminar item

- **M√©todo:** `DELETE`
- **URL:** `http://127.0.0.1:8000/items/4`
- Respuesta:
```json
{"mensaje": "Item eliminado"}
```

---

### üîç ¬øQu√© son los Query Parameters?

Son par√°metros que se agregan **despu√©s del `?` en la URL** y permiten filtrar, paginar o personalizar la respuesta.

En este ejemplo:
```python
def obtener_items(nombre: str = Query(None, description="Filtrar por nombre"))
```

- `nombre` es un **query parameter opcional**
- Si se env√≠a, filtra los items por nombre
- Ejemplo: `/items/?nombre=ana`

Puedes usar varios:
```
/items/?nombre=na&otro_param=valor
```

---

### ‚úÖ Ventajas de este enfoque

| Caracter√≠stica           | Beneficio |
|--------------------------|---------|
| JSON en el body          | Est√°ndar moderno, f√°cil de usar con frontend |
| Pydantic + BaseModel     | Validaci√≥n autom√°tica de datos |
| Query Parameters         | Filtros flexibles sin cambiar la ruta |
| Documentaci√≥n autom√°tica | Swagger UI en `/docs` |

---

Perfecto. A continuaci√≥n, te presento la **versi√≥n final y completa de la actividad pr√°ctica**, ahora con **indicaciones detalladas para estudiantes**, enfocada en **resoluci√≥n aut√≥noma** (sin dar la soluci√≥n), e incluyendo:

- Crear un fork de un repositorio
- Trabajar con entorno virtual
- Instalar dependencias
- Editar archivo `info.json`
- Desarrollar la API seg√∫n los requisitos

---

## üêæ Actividad Pr√°ctica: Gesti√≥n de Productos en una Tienda de Mascotas

> **Nivel:** Intermedio  
> **Duraci√≥n estimada:** 1.5 ‚Äì 2 horas  
> **Objetivo:** Aplicar conocimientos de FastAPI, CRUD, JSON y par√°metros de consulta en un proyecto realista, usando buenas pr√°cticas de desarrollo.

---

### üì• 1. Preparaci√≥n del entorno de trabajo

#### üîó Paso 1: Haz un **fork** de un repositorio base

1. Ve al repositorio base proporcionado por tu instructor (ejemplo simulado):
   ```
   https://github.com/jfinfosena/act_pap_s3.git
   ```

2. Haz clic en el bot√≥n **"Fork"** en la esquina superior derecha.

3. Elige tu cuenta de GitHub como destino.

4. Una vez creado, tendr√°s un repositorio en tu cuenta:
   ```
   https://github.com/tu-usuario/act_pap_s3.git
   ```

> ‚úÖ Esto te permite trabajar sobre tu copia sin afectar el original.

---

#### üì¶ Paso 2: Clona tu repositorio (el fork)

En tu m√°quina, abre una terminal y ejecuta:

```bash
git clone https://github.com/tu-usuario/act_pap_s3.git
cd act_pap_s3
```

> ‚ö†Ô∏è Reemplaza `tu-usuario` con tu nombre de usuario de GitHub.

---

#### üêç Paso 3: Crea un entorno virtual

Es importante aislar las dependencias del proyecto.

```bash
# Crear entorno virtual
python -m venv .venv

# Activar entorno (Linux/Mac)
source .venv/bin/activate

# Activar entorno (Windows)
venv\Scripts\activate
```

> Ver√°s `(.venv)` al inicio de tu terminal. ¬°Est√°s listo!

---

#### üîß Paso 4: Instala las dependencias

El proyecto ya incluye un archivo `requirements.txt` con las dependencias necesarias.

```bash
pip install -r requirements.txt
```

> Esto instalar√° `fastapi` y `uvicorn` autom√°ticamente.

---

#### üìÑ Paso 5: Diligencia el archivo `info.json`

En la ra√≠z del repositorio, encontrar√°s un archivo llamado:

```json
info.json
```

√Åbrelo y **completa los campos** con tu informaci√≥n:

```json
{
    "identificacion": "",
    "nombres": "",
    "apellidos": "",
    "grupo": "pap"
}
```

> ‚úÖ Este archivo ser√° parte de tu entrega y ayudar√° a identificar tu trabajo.

---

### üõ†Ô∏è 2. Desarrollo de la API

Ahora s√≠, es momento de programar.

#### üìÅ Estructura del proyecto

Tu repositorio debe tener estos archivos:

```
tienda-mascotas-base/
‚îÇ
‚îú‚îÄ‚îÄ main.py          ‚Üê Aqu√≠ desarrollar√°s la API
‚îú‚îÄ‚îÄ info.json        ‚Üê Ya lo completaste
‚îú‚îÄ‚îÄ requirements.txt ‚Üê Con fastapi y uvicorn
‚îî‚îÄ‚îÄ README.md        ‚Üê Instrucciones generales
```

---

#### üéØ Requisitos t√©cnicos

Crea una API FastAPI que gestione productos de una tienda de mascotas. Debes implementar:

##### ‚úÖ Modelo `Producto`
Define un modelo Pydantic con:
- `nombre: str`
- `precio: float`
- `categoria: str` (ej: "alimento", "juguetes", "accesorios")
- `stock: int`

##### ‚úÖ Modelo `ProductoParcial` (para PATCH)
Todos los campos deben ser opcionales (`Optional`).

##### ‚úÖ Base de datos simulada
Declara una lista `productos = [...]` con al menos 3 productos iniciales.

##### ‚úÖ Endpoints

| M√©todo | Ruta | Descripci√≥n |
|--------|------|-------------|
| `GET` | `/productos/` | Listar todos los productos |
| `GET` | `/productos/{producto_id}` | Obtener producto por ID |
| `GET` | `/productos/?categoria=...` | Filtrar por categor√≠a (query param) |
| `GET` | `/productos/?nombre=...` | Filtrar por nombre (b√∫squeda parcial, insensitive) |
| `POST` | `/productos/` | Crear nuevo producto (recibe JSON) |
| `PUT` | `/productos/{producto_id}` | Actualizar todos los campos del producto |
| `PATCH` | `/productos/{producto_id}` | Actualizar solo algunos campos (ej: solo el stock) |
| `DELETE` | `/productos/{producto_id}` | Eliminar un producto |

---

#### üí° Pistas para ayudarte (sin dar la soluci√≥n)

- Usa `Query(None)` para hacer los par√°metros de consulta opcionales.
- Para b√∫squedas parciales, usa `if query in item["nombre"].lower()`.
- Recuerda que `PUT` reemplaza todo; `PATCH` solo actualiza lo enviado.
- Usa `pydantic.BaseModel` para validar el cuerpo de las solicitudes.
- Ejecuta el servidor con:  
  ```bash
  uvicorn main:app --reload
  ```
- Prueba todo en **Postman** o en `http://127.0.0.1:8000/docs`

---

### üß™ 3. Pruebas recomendadas

Antes de entregar, verifica que:

- Todos los endpoints funcionen correctamente.
- Los filtros por `nombre` y `categoria` devuelvan los resultados esperados.
- Puedas crear, modificar y eliminar productos.
- Los mensajes de error (`"Producto no encontrado"`) se muestren cuando corresponde.

---

### üì§ 4. Entrega

Cuando termines:

1. Aseg√∫rate de que todo est√© guardado.
2. Haz commit y push a tu repositorio:

```bash
git add .
git commit -m "feat: completa API de productos para tienda de mascotas"
git push origin main
```

3. Entrega el **enlace a tu repositorio fork** en el sistema de tareas (Moodle, Classroom, etc.).

---



